
var time = ["[00:00.79]", "[00:02.84]", "[00:04.50]", "[00:06.43]", "[00:37.85]", "[00:40.13]", "[00:42.31]", "[00:44.34]", "[00:49.85]", "[00:52.64]", "[00:54.94]", "[00:56.80]", "[00:59.11]", "[01:01.37]", "[01:02.17]", "[01:04.23]", "[01:06.50]", "[01:10.13]", "[01:13.83]", "[01:19.67]", "[01:21.22]", "[01:24.16]", "[01:28.60]", "[01:31.85]", "[01:33.69]", "[01:36.91]", "[01:39.20]", "[01:41.10]", "[01:43.63]", "[01:46.57]", "[01:48.85]", "[01:51.69]", "[01:54.01]", "[01:56.17]", "[01:58.12]", "[01:59.55]", "[02:00.91]", "[02:03.32]", "[02:35.07]", "[02:38.79]", "[02:42.47]", "[02:48.34]", "[02:49.83]", "[02:52.78]", "[02:57.21]", "[02:59.94]", "[03:00.49]", "[03:02.21]", "[03:04.61]", "[03:08.33]", "[03:11.98]", "[03:17.95]", "[03:19.38]", "[03:23.05]", "[03:26.75]", "[03:29.03]", "[03:30.45]"];
var txt = ["安和桥 - 宇西", "词：宋冬野", "曲：宋冬野", "", "让我再看你一遍", "从南到北", "", "像是被五环路蒙住的双眼", "", "请你再讲一遍", "关于那天", "", "抱着盒子的姑娘", "", "和擦汗的男人", "", "我知道 那些夏天", "就像青春一样回不来", "代替梦想的也只能是勉为其难", "", "我知道 吹过的牛逼", "也会随青春一笑了之", "让我困在城市里", "纪念你", "", "让我再尝一口", "秋天的酒", "", "一直往南方开", "不会太久", "", "让我再听一遍", "最美的那一句", "", "你回家了", "", "我在等你呢", "", "我知道 那些夏天", "就像青春一样回不来", "代替梦想的也只能是勉为其难", "", "我知道 吹过的牛逼", "也会随青春一笑了之", "让我困在城市里", "", "纪念你", "", "我知道 那些夏天", "就像你一样回不来", "我也不会再对谁满怀期待", "", "我知道 这个世界", "每天都有太多遗憾", "所以你好", "", "再见"];

var time2 = ["[00:00.27]", "[00:01.59]", "[00:02.48]", "[00:03.52]", "[00:17.33]", "[00:20.90]", "[00:24.29]", "[00:27.54]", "[00:29.18]", "[00:34.07]", "[00:36.30]", "[00:41.44]", "[00:43.56]", "[00:45.17]", "[00:46.48]", "[00:49.35]", "[00:50.05]", "[00:53.55]", "[00:54.10]", "[00:56.29]", "[00:59.73]", "[01:00.74]", "[01:02.50]", "[01:04.27]", "[01:07.70]", "[01:08.20]", "[01:10.04]", "[01:14.00]", "[01:14.88]", "[01:17.67]", "[01:18.42]", "[01:21.86]", "[01:22.49]", "[01:24.67]", "[01:27.99]", "[01:29.15]", "[01:31.00]", "[01:32.74]", "[01:36.68]", "[01:38.47]", "[01:42.62]", "[01:46.37]", "[01:49.71]", "[01:53.38]", "[01:56.69]", "[01:58.08]", "[02:03.31]", "[02:05.16]", "[02:10.90]", "[02:11.88]", "[02:14.51]", "[02:15.39]", "[02:18.07]", "[02:18.91]", "[02:22.39]", "[02:22.94]", "[02:25.17]", "[02:28.34]", "[02:29.62]", "[02:31.43]", "[02:33.16]", "[02:36.59]", "[02:37.13]", "[02:38.89]", "[02:42.94]", "[02:43.81]", "[02:46.47]", "[02:47.35]", "[02:50.78]", "[02:51.36]", "[02:53.61]", "[02:56.62]", "[02:58.05]", "[02:59.95]", "[03:01.65]", "[03:05.00]", "[03:05.60]", "[03:07.44]", "[03:11.59]", "[03:24.07]", "[03:26.60]", "[03:27.45]", "[03:30.22]", "[03:30.96]", "[03:35.51]", "[03:38.97]", "[03:41.64]", "[03:42.49]", "[03:45.98]", "[03:46.57]", "[03:48.77]", "[03:52.38]", "[03:53.23]", "[03:55.02]", "[03:56.75]", "[04:00.15]", "[04:00.74]", "[04:02.60]", "[04:06.08]", "[04:07.47]","[04:09.21]","[04:10.95]","[04:14.35]","[04:14.97]","[04:16.71]"];
var txt2 = ["修炼爱情 - 宇西", "词：易家扬", "曲：林俊杰", "", "凭什么要失望", "", "藏眼泪到心脏", "", "往事不会说谎别跟它为难", "", "我们两人之间不需要这样", "", "我想", "", "修炼爱情的心酸", "", "学会放好以前的渴望", "", "我们那些信仰", "要忘记多难", "", "远距离的欣赏", "近距离的迷惘", "谁说太阳会找到月亮", "", "别人有的爱", "我们不可能模仿", "", "修炼爱情的悲欢", "", "我们这些努力不简单", "", "快乐炼成泪水", "是一种勇敢", "", "几年前的幻想", "几年后的原谅", "为一张脸去养一身伤", "别讲想念我", "我会受不了这样", "", "记忆它真嚣张", "", "路灯把痛点亮", "", "情人一起看过多少次月亮", "", "它在天空看过多少次遗忘", "", "多少心慌", "", "修炼爱情的心酸", "", "学会放好以前的渴望", "", "我们那些信仰", "要忘记多难", "", "远距离的欣赏", "近距离的迷惘", "谁说太阳会找到月亮", "", "别人有的爱", "我们不可能模仿", "", "修炼爱情的悲欢", "", "我们这些努力不简单", "", "快乐炼成泪水", "是一种勇敢", "", "几年前的幻想", "几年后的原谅", "为一张脸去养一身伤", "", "别讲想念我", "我会受不了这样", "", "笑着说爱让人疯狂", "", "哭着说爱让人紧张", "", "忘不了那个人就投降", "", "修炼爱情的悲欢", "", "我们这些努力不简单", "", "快乐炼成泪水", "是一种勇敢", "", "几年前的幻想", "几年后的原谅", "为一张脸去养一身伤", "", "别讲想念我", "我会受不了这样", "", "几年前的幻想","几年后的原谅","为一张脸去养一身伤","别讲想念我","我会受不了这样"];


$(function(){
	var initTop = 20,  //歌词初始top
		start = 1,		//数组初始值
		duration = 0,	//音频时长
		audio = $('audio').get(0), //音频
		progresslength = $('.progress').width(),//播放条长度
		song_name = $('.head h2').attr('data-song'); //当前歌曲
	// 播放歌曲图标 
	var play_status = $('.song-list').find('li[data-song='+ song_name +']').find('p s');

	/*
	 每次换歌初始样式
	 1 设置歌手头像，背景图片，圆图片
	 2 播放按钮--播放状态
	 3 进度条长度归0
	 4 起始时间归0
	 5 歌词(p)去掉old样式
	 6 play-rotate的animationPlayState为paused
	 7 

	*/

	$('.play-rotate').css('animationPlayState','paused');
	$('#toggle-play').tap(function(){
		$(this).toggleClass('active');
		$('.play-rotate').hasClass('animation') == false && $('.play-rotate').addClass('animation');
		// 播放按钮重置
		$('.head i').css('backgroundPosition','16px 532px');
		// 播放时间重置
		if($('.currentPro').width() == progresslength){
			$('.song-box p').removeClass('old');
			$('.startMinute').text('00');
			$('.startSecond').text('00');
			// 进度条
			$('.currentPro').css('width','0px');
			//歌词位置 
			$('.song-box').css('top','20px');
		}
		// 播放状态
		if($(this).hasClass('active')){
			audio.play();
			$('.play-rotate').css('animationPlayState','running');
			// 歌曲列表当前歌曲状态
			play_status.show();
		}else{ //暂停状态
			audio.pause();
			$('.play-rotate').css('animationPlayState','paused');
			$('.head i').css('backgroundPosition','16px 560px');
			play_status.hide();
		}
	})
	//设置播放器的位置及高度
	var rwidth = $('.play-rotate').width();
	$('.play-rotate').css({
		'height': rwidth,
		'marginLeft': -(rwidth / 2)
	})

	
	// 向左滑切换到下一首
	$('.play-rotate').tap(function(){

		$(this).removeClass('animation').css({
			
			'transform':'rotateY(180deg)',
			'transition':'all 5s'
			
		})
		// 播放按钮样式
		$('#toggle-play')[0].style = '';
		$('#toggle-play').removeClass('active')
		// 改变背景
		$('#singer').attr('src','../images/hot10.jpg');
		$('.bg-box img').attr('src','../images/hot10.jpg');
		$('.play-rotate').css('backgroundImage','url(../images/hot10.jpg )')
		$('.head-info h2').text('修炼爱情');
		
		//歌词位置 
		$('.song-box').css('top','20px');
		$('.song-box p').removeClass('old');
		
		// audio 原文件
		$(audio).remove();
		$('body').append($('<audio class="nextAudio"><source src="../music/xiulianaiqing.mp3"/></audio>'));
		$('.song-box p').remove();

		$.each(txt2,function(index,item){

			item == '' ? $('.song-box').append($('<p>.<p>')) : $('.song-box').append($('<p>'+item+'<p>'));
		});

		$('.song-box p').each(function(index,item){
			item.innerHTML == '' && $(this).remove();
		})

		audio = $('.nextAudio').get(0);

		audio.oncanplay = function(){

			duration = audio.duration;
			setSongTime(Math.round(duration));
			// 进度条
			$('.currentPro').css('width','0px');
			$('.startMinute').text('00');
			$('.startSecond').text('00');
		}
		audio.ontimeupdate = function (){
			playUpdate(this,time2,duration);
		}

	})

	// 向右滑回到首页
	$('body').swipeRight(function(){
		window.location.href = '../index.html';
	})



	// 点击头像，显示播放列表
	var song_name = $('.head h2').attr('data-song');
	$('#singer').tap(function(){
		$('.song-list').toggleClass('show');
		
		// 获取当前播放歌曲
		$('.song-list').find('li[data-song='+ song_name +']').find('p').addClass('playing');
	})



	// 设置初始歌词盒子的位置
	var box = $('.song-box');
	box.css('top','20px');
	// 创建歌词p元素
	$.each(txt,function(index,item){

		item == '' ? $('.song-box').append($('<p>.<p>')) : $('.song-box').append($('<p>'+item+'<p>'));
	});

	$('.song-box p').each(function(index,item){
		item.innerHTML == '' && $(this).remove();
	})

	
	// 时间初始化
	audio.oncanplay = function(){
		duration = Math.round(this.duration);
		setSongTime(duration);
	}

	
	// 音频播放时触发
	audio.ontimeupdate = function() {
		playUpdate(this,time,duration);
	};

	// 音频停止事件
	audio.onended = function(){
		// 播放按钮
		$('#toggle-play').toggleClass('active');
		// 播放按钮重置
		$('.head i').css('backgroundPosition','16px 560px');
		// 暂停旋转
		$('.play-rotate').css('animationPlayState','paused');
		play_status.hide();
		console.log($('.currentPro').width() + '|'+ $('.progress').width());
	}

	/*
		格式化并设置歌曲结束的时间

	*/
	function setSongTime(duration){
		var minute = parseInt(duration / 60);
		minute = minute >= 10 ? minute : '0'+ minute;
		// 秒
		var second = parseInt(duration % 60 );
		second = second >= 10 ? second : '0'+ second;

		$('.endMinute').text(minute);
		$('.endSecond').text(second);
	}

	/*
	播放时间
	obj：audio对象
	songData：歌词数组
	duration：歌曲时长
	*/
	function playUpdate (obj,songData,duration){
		var current = initTime = obj.currentTime.toFixed(0);
		// 播放时间
		var initM = parseInt(initTime / 60);
		var initS = initTime % 60;
		initM = initM >= 10 ? initM : '0' + initM;
		initS = initS >= 10 ? initS : '0' + initS;
		$('.startMinute').text(initM);
		$('.startSecond').text(initS);


		// 进度条长度
		var currentLength = progresslength * current / duration;
		$('.currentPro').css('width',currentLength)
		// 歌词样式
		$('.song-box p').eq(start-1).addClass('current').siblings().removeClass('current');
		start-2 >= 0 && $('.song-box p').eq(start-2).addClass('old');
		while(songData[start] && current == normalize(songData[start]) ){
			initTop  -= 21.5 ;
			box.animate({
				'top': initTop+'px'
			});
			start++;
		}
	}
	
	/*
	格式化时间
	time ：后台传到前台歌词时间
	*/
	function normalize(time){
		var timeArr = time.substr(1,time.length-2).split(':');
		// 整秒数
		var second = parseInt(timeArr[0]);
		var floatTime = parseFloat(timeArr[1]);
		var normalize = second * 60 + floatTime;
		// 四舍五入不保留小数
		return normalize.toFixed(0)
	}

})
